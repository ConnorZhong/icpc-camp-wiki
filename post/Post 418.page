# Codeforces Round #352E Ultimate Weirdness of an Array

给出$n (n \leq 2 \times 10^5)$个数，$a_i \le 2 \times 10^5$
求 $$ \sum_{1 \leq l \leq r \leq n} \max_{i, j \notin [l, r]} \gcd(a_i, a_j)$$

[QAQ wrote on 2016-05-11T18:47:12]

---

这个该怎么捉呀？

[QAQ wrote on 2016-05-11T18:47:32]

---

令K为2e5之内因子数最多的数的因子个数，感觉可以O(nK)预处理出所有f_i(r)=max(gcd(a_i,a_j)),j \in [r,n]（这是个O(K)段的分段函数）。然后算答案的时候好像需要一堆f_i的max，这个大概可以在保证能算出答案的前提下维护，总开销看上去也是O(nK)的。大体上还要处理一下i和j同时取自[1,l]或[r,n]的情况，还没仔细想，不过应该能handle过来。。

[fotile96 wrote on 2016-05-12T02:46:14]

---

http://codeforces.com/contest/671/submission/17870280

题解好难写。。。随便 bb 一下好了。。。

我们希望维护一个集合 $S$，里面是一些 $[l, r]$ 的二元组，这些二元组的值（就是说挖掉 $[l, r]$ 区间后剩下元素的最大 gcd）都是 $< d$ 的。
如果对于每个 $d$ 都知道了上述集合的大小，其实我们就知道了 值恰好是 $d$ 的二元组的个数，算答案也不是什么难事啦。

我们下面看一下怎么维护这个集合。假设现在集合里面的值都是 $< d + 1$的，现在想要变成 $< d$ 的，那么很明显，我们需要做的就是把值 $\geq d$ 的二元组 $[l, r]$ 从集合里面删掉。

那么现在考虑所有 $d$ 的倍数，$a_{i_1}, a_{i_2}, \ldots, a_{i_{k - 1}}, a_{i_k}$，那么如果 $[l, r]$ 之外有至少 $2$ 个，这组 $[l, r]$ 的值肯定就要 $\geq d$ 了。反过来说，合法的是什么呢？就是说 $[1, l)$ 和 $(r, n]$ 加起来小于 $2$ 个。所以这里 $d$ 的倍数虽然很多，只要保留最前 $2$ 个和最后 $2$ 就可以了。
具体地说，$S$ 集合里面 $r$ 一定要 $> i_{k - 1}$，如果 $l \geq i_1$ 则 $r > i_k$，如果 $l \geq i_2$ 则 $r > n$。也就是说，这个 $S$ 无论何时何刻，都是一些 $\{(x, y) : x \geq a, y \geq b\}$ 集合的交，拿个 std::set 维护就好了。

---

这么做的复杂度应该是 $O(m \log m)$ 的，但是上面的程序用了 std::sort 所以实际上是 $O(m \log^2 m)$ 的，换成 std::nth_element 或者类似的东西就可以做到这个复杂度了。

[ftiasch wrote on 2016-05-12T03:48:58]

---

显然满足$f(i,j) \geq d$的区域包括了满足$f(i,j) \geq d+1$的区域，现在从大到小枚举$d$，根据@Hayashimo#3566 的分析，每次刷三个矩形区域，新刷上的部分就是满足$f(i,j)=d$的区域，容易发现每个矩形在$i<=j$的部分里只有一个角，把$i>j$的部分砍了然后坐标系转45°度就是[这个题](http://codeforces.com/gym/100796/problem/B)。

[quailty wrote on 2016-05-12T11:57:24]

---

