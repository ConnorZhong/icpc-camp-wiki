# Hefei 2015 C Autopilot System

http://acm.hdu.edu.cn/showproblem.php?pid=5554

在一棵树上， $N$ 个城市， $N-1$ 条路， 需要从 $1$ 号走到 $N$ 号。其中有 $M$ 个特殊的点，  每一个点都有 $q_i$ 的概率飞到第 $i$ 个特殊的点， 设这 $M$ 个 $q_i$ 的和为 $\mathrm{sum}$， 某个点 $u$ 的度为 $K$ 。则每个点有 $(1 - \mathrm{sum}) / K$ 走到他的某个相邻节点。 
求从 $1$ 走到 $N$ 的期望步数（通过特殊通道到特殊点的不计入步数）。

$N \leq 2 \times 10^4, M \leq 200$

我的解法是把 $M$ 个特殊点走到 $N$ 点的期望步数设为 $x_i $， 先用树形 dp 把每个点表示成关于 $M$ 个未知数的表达式， 那么对那 $M$ 点而言， 就形成了 $M$ 个方程。 然后用高斯消元法解方程。

感觉没有什么特殊的情况需要讨论了但是一直WA， 求菊苣指导一下AC的解法， 顺带求AC代码对拍。

[续一秒 wrote on 2015-11-19T08:42:31]

---

感觉你做得很对啊

[ftiasch wrote on 2015-11-19T09:27:38]

---

@Varona#2735  http://paste.ubuntu.com/13343322/

是不是还有什么地方需要特判啊？

[续一秒 wrote on 2015-11-19T09:45:03]

---

@续一秒#2736 其实不需要高斯消元，直接解方程就行。。。我试了很多发都没过，对拍后觉得应该是精度问题吧= =

[mayf3 wrote on 2015-11-19T10:07:49]

---

@mayf3#2737  菊苣， 我在hdu上看到你过了。 你后来怎么改过的？ 求教。

[续一秒 wrote on 2015-11-24T13:44:32]

---

@续一秒#2844 好吧。。我其实没有改什么，后来一个师兄过了，然后我找他要了代码，后来发现，原来我WA的原因是，long double我用了printf("%Lf\n", ans)输出，但是hdu上不支持Lf，我换成printff("%.12f\n", (double)ans)就过了。。感觉就是换成long double可以过，精度要求很高吧

[mayf3 wrote on 2015-11-25T01:28:57]

---

@mayf3#2854  菊苣， 求代码。

[续一秒 wrote on 2015-11-25T08:32:16]

---

@续一秒#2856 http://paste.ubuntu.com/13501448/

[mayf3 wrote on 2015-11-25T10:29:24]

---

@_ilovelife ， 菊苣， 可以看下你合肥场C题的代码么

[续一秒 wrote on 2015-11-25T12:12:30]

---

@mayf3#2857  虽然对拍出来有不一样的， 差别最多达到了3位小数， 但是还是不知道为什么= =，  菊苣你是怎么列方程的， 没看懂啊

[续一秒 wrote on 2015-11-25T12:14:05]

---

@续一秒#2863 http://paste.ubuntu.com/13502152/
我是高斯消元解的，特判掉了终点也在那m个点当中的情况。。。。

[_ilovelife wrote on 2015-11-25T13:22:10]

---

这题我感觉精度有点问题……最后靠着枚举了一遍eps通过了

[sd_invol wrote on 2015-11-25T18:53:22]

---

 先用树形dp把每个点表示成关于M个未知数的表达式.
这个是怎么搞的？

[prime21 wrote on 2016-03-13T13:53:34]

---

@prme21#3322 

设 $f(u)$ 表示点 $u$ 走到点 $N$ 的期望，则
$$f(u) = \sum_{i = 1}^M q_i x(\mathrm{special}_i) + \sum_{v \in N(u)} \frac{1 - \mathrm{sum}_u}{K_u} f(v) + 1$$.

虽然实际上 $x(\mathrm{special}_i) = f(\mathrm{special}_i)$，但是这里先作为变量看待。

现在把点 $N$ 作为根，上面那个好长的式子可以从重新写作
$$f(u) - f(\mathrm{parent}(u)) = \sum_{i = 1}^M q_i x(\mathrm{special}_i) + \sum_{v \in \mathrm{children}(u)} \frac{1 - \mathrm{sum}_u}{K_u} f(v) + 1$$

现在从叶子到根用这个式子，在叶子的时候，只会涉及叶子和叶子的父亲，相当于把叶子用父亲表示了出来。再往上推一层，因为叶子已经用父亲表示出来了，再倒一下就能表示出新的父亲，一步一步推到根，因为 $f(N) = 0$ 是知道的，所以相当于就把第一层儿子算了出来，再往回算一遍就能算出所有点的值。注意这里的值实际上不是一个数，而是 $x(\mathrm{special}_1), x(\mathrm{special}_2), \ldots, x(\mathrm{special}_M)$ 的线性组合。

然后就高斯消元就好了。

[ftiasch wrote on 2016-03-14T01:55:19]

---

