# 一道线段树题

## Description
一个初始全为 $0$ 的序列 $A_1, A_2, \cdots, A_n$。共有 $m$ 次操作：

1. 将区间 $[l, r]$ 中的数 $+1$。
2. 将区间 $[l, r]$ 中的数置 $0$。
要求最后输出每个位置上历史最大值。

## Data Range
$n, m \leq 10^5$

======================

大概要维护一个历史最大标记？？？。。
想不清楚。求神犇指点

[Cab wrote on 2016-02-20T03:37:11]

---

首先，每个操作都可以表示成一个线性函数 $f_i(x) = a_i x + b_i$. 比如说操作 1 对应的是 $a_i = b_i = 1$，操作 2 对应的是 $a_ i = b_i = 0$. 

然后，考虑操作 $f_1, f_2, \ldots, f_q$，我们要求的实际上是 $\max_i F_{1, i}(0)$，其中 $F_{i, j} =  f_j \ldots f_{i+1} \circ f_i$，$\circ$ 表示函数的复合。

可以注意到，$f_i$ 是单调不减的线性函数，所以复合的 $F_{i, j}$ 也是单调不减的线性函数。也就是说 $F_{i, j}(x) = A_{i,j} x + B_{i,j}, A_{i,j} \in \{0, 1\}, B_{i,j} \geq 0$。

现在为了求出 $\max_{l \leq i \leq r} F_{1, i}(0)$，可以先写作 $\max_{l \leq i \leq r} F_{l, i}(F_{1, l - 1}(0))$。根据上面的分析，$F_{l, i}$ 只有 $0x + C$ 和 $1x + C$ 这两种形式。而只要 $C > D$，那么 $ax + C$ 显然是比 $ax + D$ 要好的。所以只要算出 $M_{0, l, r}$ 和 $M_{1, l, r}$ 表示两种情况下常数的最大值，那么这部分的答案就是 $\max\{M_{0, l, r}, F_{1, l - 1}(0) + M_{1, l, r}\}$.

最后的问题是怎么维护 $M_0$ 和 $M_1$ 了，你会发现只要维护左右两段的 $M_0$ 和 $M_1$ 以及复合起来的变换，就可以维护了。

（感觉没有掌握先进的数学符号，所以导致上面这一段不太容易看懂 orz）

---

（下面是说人话的版本）

你看一段操作，无非是最开始 +++，突然清零了，后面再怎么动就跟初始值没关系了。

所以现在你要合并两段标记，之前的历史最大值，以及最后加到了多少（对应上面的 $F_{1, l - 1}(0)$），当然是要知道的。对于后面这一段，只要知道 +++ 的时候加到了多少（对应上面的 $M_{1, l, r}$），以及清零之后又加到了多少（对应上面的 $M_{0, l, r}$），就可以知道这一段新出现的最大值了。

[ftiasch wrote on 2016-02-21T04:49:37]

---

@Varona#3159 
没想到会有人这么认真地回复。。谢谢
大致懂了，是不是离线做，相当于对时间维护线段树，维护区间历史最大值、前缀及后缀最多连续1的个数，和区间中最多连续1的个数？

[Cab wrote on 2016-02-22T14:06:16]

---

@Varona#3159 
然后还有，其实这题原题是在坐标平面上，对矩形区域内的点进行相应操作的。。标解应该是 KD Tree。
不知这种做法能不能套上去？

[Cab wrote on 2016-02-22T14:26:12]

---

@Cab#3165 

不是，不需要离线。

我描述的其实是标记合并的过程，所以线段树平衡树 k-d 树都是可以的。

[ftiasch wrote on 2016-02-22T15:41:36]

---

更一般的情形可以参考2016NOIWC营员交流的“线段树带来的沉重打击”

[quailty wrote on 2016-02-23T11:10:48]

---

我还是没想明白怎么做，哪位大神能提供一下代码？

[yuki wrote on 2016-03-06T03:11:48]

---

