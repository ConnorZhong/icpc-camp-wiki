# 51nod 1129 机器人方阵

[题目链接](http://www.51nod.com/onlineJudge/questionCode.html#!problemId=1129)
有 $N$ 个高矮互不相等的机器人，排成一个方阵，要求每一行中，每一列中后面的机器人要比前面的高。问有多少种不同的排列方法，答案模 $10007$。$N\le 10\^9$。
也就是求[这个数列](http://oeis.org/A067228)的第 $N$ 项 $\bmod 10007$。

[skywalkert wrote on 2015-10-09T08:07:49]

---

[IMG]http://static.icpc-camp.org/flarum-emotion/blue-cat.jpg[/IMG]
新手求助

[skywalkert wrote on 2015-10-13T11:33:36]

---

@skywalkert#1771 实在不会做……

[ftiasch wrote on 2015-10-13T13:54:09]

---

以下是我口胡
首先枚举下方阵的规模, 不妨设为$d \times \frac{n}{d}$, 这里只需要考虑$d \le \sqrt{n}$就好了, 剩下的是对称的, 乘个2就好了, 如果$n$是完全平方数, 减去多算的就好了.

然后考虑钩子公式这个方阵的答案就是$\frac{n!}{\prod\limits\_{i=0}\^{d-1}\prod\limits\_{j=0}\^{\frac{n}{d}-1}(i+j+1)}$事实上, 我们在格子$(i,j)$上写出$i+j+1$就会发现, 令$e=\frac{n}{d}+d-1$, 分母大概是这个样子, $1\^12\^2\cdots d\^d(d+1)\^d\cdots (e-d)\^d (e-d+1)\^{d-1}\cdots e\^1$. 然后有个隐藏的限制, $d$的个数不多, 最多只有800个, 于是我们就可以搞这个题了.

模数比较小, 考虑把分子和分母都写成$a \times 10007\^b$的形式, 把$n!$写成这样形式比较简单, 这里不表.  然后只需要把分母写成上述形式就好了. 由于$d$的个数不多, 且$d \le \sqrt{n}$, 分母首尾部分就可以直接暴力, 至于中间部分可以看成两个阶乘相除的$d$次, 同样可以套用阶乘的做法. 于是这个题就搞定了.

我猜复杂度应该够过这个题.

[zimpha wrote on 2015-10-13T14:57:01]

---

@zimpha#1781 刚过。。想了挺久的。。。最后是被你的D和N/D是对称的给提醒到了。。
做法是这样的，对于D和N/D，其实只需要计算大的那个D就行了（大于根号N的那个）
对于每个D，暴力N/D去计算连乘{k=0~N/D-1, k!/(i+k)!}，然后最后把答案加起来就行了
for(int i = 1; i * i <= n; i++){
		if (n % i) continue;
		if (i * i == n) ret = (ret + calc(n / i)) % MOD;
		else ret = (ret + 2LL * calc(n / i)) % MOD;
	}
然后完了其实要解决的就是那个连乘的答案
我们分开分子和分母来考虑，对于任何N的阶乘都可以写成A×MOD^K
然后乘法和除法可以通过逆元来搞（A部分与MOD互质），然后MOD部分就直接加减就行了
最后剩下的问题就是N的阶乘写成A×MOD^K的格式了，做法和C(N,M)%P^C的做法一样，就递归就行
最后复杂度就是根号N×logN

好吧。。刚看到下文原来你已经把做法说清楚了。。我看了开头两行就去写代码了。。太丢人了..

[mayf3 wrote on 2015-10-13T15:43:44]

---

