# 2017 湖南省赛 G

给一个 $1$ 到 $n$ 的排列，求有多少个区间重排之后是等差数列，$n\le 10^5$

[hiaatcnd wrote on 2017-09-02T09:45:00]

---

我口胡下我刚想的做法，不知道对不对。

我们先考虑如何判断一个区间$[l,r]$是不是等差数列：
求出区间最大值$max$，最小值$min$，以及区间相邻两数的差值的$gcd$
那么如果$max-min=(r-l)gcd$，它就是个等差数列。

现在我们考虑怎么求出方案数。
从$1$到$n$枚举每个位置作为$r$，统计符合条件的$l$的个数，注意到固定$r$之后$gcd$只有$O(\log n)$段，我们可以对于每一段分别求解。
区间内有$r-l+1$个数，排序之后相邻两个数之差至少是$gcd$，因此$max-min\geq (r-l)gcd$。
换句话说，我们只需要求出$max-min+l\times gcd$的最小值，以及最小值的个数，就可以求出符合条件的$l$的个数了。

对于$max$和$min$是很好维护的，只需要维护两个单调栈，每次栈发生变化的时候修改一段区间的$max$和$min$即可，方便起见可以转化成区间加操作。
而对于$l\times gcd$，对于固定的$l$来说，往右只会在$O(\log n)$个$r$处变化$gcd$，因此对于每一次变化，暴力修改这个值即可，也可以用区间加实现。
于是我们需要维护一个序列，支持区间加，询问区间最小值以及最小值的个数，普通的线段树就可以实现这些功能了。

总时间复杂度$O(n\log^2n)$。

[Claris wrote on 2017-09-02T13:00:37]

---

