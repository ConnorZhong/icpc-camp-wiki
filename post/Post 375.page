# PKU Campus 2011 E题的解法

训练的时候遇到了这道题，感觉没有思路，求指导。
开始思考，树型转线型，可以做从每个点出发的最短路。对于kth path的做法，毫无思路，30 roads的条件也不知道如何应用。
http://poj.openjudge.cn/campus2011/E/

[xwind wrote on 2016-03-13T07:53:27]

---

如果要计算 $v$ 的答案，假设 $v$ 的祖先（包括自己 $v$）是 $v_0, v_1, \ldots, v_k$，显然 $k \leq 30$。二分答案 $\lambda$，那么就是要统计有多少 $u$ 使得 $\delta(u, v) \leq \lambda$，为了计算这个，只要枚举 $\mathrm{LCA}(u, v) = v_i$，然后计算 $v_i$ 不包括 $v$ 的子树下有多少个 $w$ 满足 $d(w)  \leq \lambda - d(v) + 2 d(v_i)$. 这个只要按照值域，对着 dfs 序列建一个持久化线段树，那么「$v_i$ 去掉 $v$ 这颗子树」这个东西其实就是 dfs 序列上的两段。所以最多会有 $61$ 段，这样复杂度是 $O(61 \log M \log n)$。

~~当然大家也知道，其实先二分再去线段树上查是个很鱼唇的事情。所以只要把 $61 * 2$ 棵线段树拍在一起二分，就能省一个 log 了。~~

[ftiasch wrote on 2016-03-13T08:58:17]

---

非常感谢，那个61*2颗线段树的解法消log的解法很有启发

[xwind wrote on 2016-03-13T16:14:45]

---

@xwind#3323 好像 sb 了，直接拍一起二分是不对的。

[ftiasch wrote on 2016-03-14T01:39:22]

---

@xwind#3323 

（修一下）为了能够一起二分，我们必须对于每个点 $u$ 求出一颗线段树 $\mathrm{SGT}(u)$ 表示以它为根的子树内所有点组成的权值线段树，点 $v$ 的权值应该是 $\mathrm{depth}(v) - 2\mathrm{depth}(u)$. 这样才能拍在一起二分。构造的时候不需要（也不能）启发式合并什么的，直接暴力构造就行了。总节点数应该是 $\sum_u \mathrm{depth}$ 的。

还有一个小优化，你可以把直径中点当根，这样深度最多只有 $15$ 了少了一半。

[ftiasch wrote on 2016-03-14T01:46:07]

---

@Hayashimo#3325 写了一个小时，发现死活凑不到一起，过来看到这种消息我的内心是崩溃的。直接构造的总结点数喂猫是$\sum_u depth$的？，而且直径应该是60吧？就算是半径的话，那中点和根的之间路径，你仍然还是要去枚举吧。

[xwind wrote on 2016-03-14T04:59:46]

---

@xwind#3327 

* 因为一个点只会被算到这么多次啊……

* 大家距离不超过 30 啊，直径哪能是 60。

[ftiasch wrote on 2016-03-14T05:37:54]

---

@Hayashimo#3329 对于二分确实是这样的，我之前没有理解到位，但是题意是其他所有点距离1号点的段数不超过30呀，应该是您看错题了，那个枚举中点的优化，我明白了。
我再去写一发。之前那个$61*log*log$的T了

[xwind wrote on 2016-03-14T06:27:31]

---

